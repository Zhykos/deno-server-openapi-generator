import { assertEquals } from "https://deno.land/std@0.127.0/testing/asserts.ts";

// Test all routes from example which always returns an error: this tests is built to check if all routes are generated.
// deno test --allow-net --unstable DenoPetStoreExampleRouteTests.ts

const client = Deno.createHttpClient({});

{{#apiInfo}}
{{#apis}}
{{#operations}}
{{#operation}}
Deno.test("check if route exists for service: {{classname}}Service >> {{{operationId}}}", async() => {
    const localVarPath = `{{{path}}}`{{#pathParams}}.replace(`{${"{{baseName}}"}}`, stubParameter("{{{dataType}}}")){{/pathParams}};

    const res = await fetch("http://localhost:3000" + localVarPath, {
        method: "{{httpMethod}}",
        client
    });
    await res.body?.cancel();
    assertEquals(res.status, 500);
});

{{/operation}}
{{/operations}}
{{/apis}}
{{/apiInfo}}

Deno.test("404 status", async() => {
    const res = await fetch("http://localhost:3000/zhykos404", {
        method: "GET",
        client
    });
    await res.body?.cancel();
    assertEquals(res.status, 404);
});

function stubParameter(paramType: string): string {
    if (paramType == "number") {
        return encodeURIComponent(String("1"));
    }
    if (paramType == "string") {
        return encodeURIComponent(String("foo"));
    }
    throw new Error("Unknown type to stub: " + paramType);
}